# План задач: регистрация через бот, мультибот и восстановление пароля

## Цель
Привести проект к стабильной SaaS-логике:
- у каждого клиента (ресторана) свой Telegram Bot Token;
- регистрация покупателей идет через бот конкретного ресторана;
- есть безопасное восстановление пароля через Telegram-бота;
- устранены критичные баги и рассинхрон в backend/frontend/docs.

## Этап 1. Аудит и критические баги
- [x] Проверить и исправить ошибки в `server/bot/multiBotManager.js` (состояния, колбэки, конкурентные сценарии) - базовые критичные фиксы внесены.
- [x] Устранить рассинхрон схемы БД и кода (например, `is_blocked` в `user_restaurants`).
- [ ] Проверить конфликты ролей (`superadmin/operator/customer`) в API и UI.
- [ ] Убрать дубли и устаревшие ветки логики (где ломают текущий поток).

Критерии готовности:
- сервер стартует без ошибок;
- бот не падает в основных сценариях (`/start`, регистрация, меню, заказ);
- миграции консистентны с фактическими SQL-запросами.

## Этап 2. Мультибот по клиентам (ресторанам)
- [ ] Проверить и стабилизировать инициализацию ботов по `restaurants.telegram_bot_token`.
- [ ] Гарантировать, что пользователь регистрируется в контексте нужного ресторана.
- [ ] Проверить webhook/polling режимы и маршрутизацию по `restaurantId`.
- [ ] Добавить валидации токена/группы и понятные ошибки в админке.
- [x] Добавлен self-registration оператора через команду `/operator` с кодом приглашения ресторана (`operator_registration_code`).

Критерии готовности:
- для каждого ресторана работает свой бот;
- пользователи не смешиваются между ресторанами;
- новый ресторан с токеном подключается без ручных правок кода.

## Этап 3. Восстановление пароля через бота
- [x] Спроектировать flow: команда (например `/reset_password`) + подтверждение через Telegram ID.
- [x] Реализовать безопасную генерацию временного пароля или одноразовой ссылки.
- [x] Добавить ограничения: rate limit, TTL кода/ссылки, защита от перебора.
- [ ] Обновить пароль в БД с bcrypt и записать событие в логи.
- [x] Добавить UX-сообщения в боте (успех, ошибка, истекший код).

Критерии готовности:
- оператор/пользователь может восстановить доступ без участия супер-админа;
- сценарий не открывает дыру безопасности;
- все попытки восстановления логируются.

## Этап 4. UI и документация
- [ ] Обновить тексты/подсказки на странице логина и в админках под новую модель.
- [ ] Обновить `docs/LOGIN_SYSTEM.md`, `README.md`, onboarding инструкции.
- [ ] Добавить краткую инструкцию для клиента системы: как привязать токен и запустить регистрацию.

Критерии готовности:
- документация совпадает с реальным кодом;
- новый клиент может пройти запуск по инструкции без разработчика.

## Этап 5. Тестирование и приемка
- [ ] Smoke-тест backend маршрутов auth/admin/superadmin/bot.
- [ ] E2E-сценарий: новый ресторан -> токен -> регистрация покупателя -> логин -> заказ.
- [ ] E2E-сценарий: восстановление пароля через бот.
- [ ] Регрессия существующих заказов/статусов/уведомлений.

Критерии готовности:
- нет критических регрессий по заказам и уведомлениям;
- бизнес-сценарии заказчика проходят полностью.

## Оценка времени
- Этап 1: 6-8 часов
- Этап 2: 6-8 часов
- Этап 3: 4-8 часов
- Этап 4-5: 3-4 часа

Итого: 19-28 часов (примерно 2-3 рабочих дня).

## Результат поставки
- исправленный backend и bot-flow;
- миграции/изменения БД;
- обновленный frontend (где требуется);
- актуальная документация;
- чек-лист тестов с фактическим статусом.
