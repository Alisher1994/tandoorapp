<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    :root {
      --md-primary-color: #2e2982;
      --md-primary-dark: #25216b;
      --md-primary-light: #3a34a0;
      --md-accent-color: #424242;
      --md-background-color: #F5F5F5;
      --md-surface-color: #FFFFFF;
      --md-text-color: #212121;
      --md-text-secondary: #757575;
      --md-border-color: #E0E0E0;
      --md-shadow-color: rgba(0, 0, 0, 0.12);
      --md-shadow-hover: rgba(0, 0, 0, 0.18);
    }

    body {
      background-color: var(--md-background-color);
      color: var(--md-text-color);
      font-family: 'Roboto', sans-serif;
    }

    .form-control, .select2-container--default .select2-selection--single {
      border-radius: 8px;
      border: 1px solid var(--md-border-color);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
      padding: 0.5rem 1rem;
      height: calc(1.5em + 1rem + 2px);
      font-size: 1rem;
      background-color: var(--md-surface-color);
      color: var(--md-text-color);
    }

    .form-control:focus, .select2-container--default.select2-container--focus .select2-selection--single {
      border-color: var(--md-primary-light);
      box-shadow: 0 0 0 0.25rem rgba(46, 41, 130, 0.25);
    }

    .select2-container--default .select2-selection--single {
      line-height: calc(1.5em + 1rem + 2px);
      padding: 0 1rem;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: calc(1.5em + 1rem + 2px);
      color: var(--md-text-color);
      padding-left: 0;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: calc(1.5em + 1rem + 2px);
      right: 12px;
      top: 0;
      width: 20px;
    }

    .select2-container {
      width: 100% !important;
    }

    .select2-dropdown {
      z-index: 9999 !important;
    }

    .category-card {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--md-border-color);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      background: var(--md-surface-color);
      box-shadow: 0 4px 8px var(--md-shadow-color);
      height: 100%;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      cursor: pointer;
    }

    .category-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px var(--md-shadow-hover);
    }

    .category-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      background: var(--md-background-color);
      margin-bottom: 10px;
    }

    .category-name {
      font-size: 1.1rem;
      line-height: 1.4em;
      font-weight: 600;
      color: var(--md-text-color);
      margin: 0;
    }

    .product-card {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--md-border-color);
      border-radius: 8px;
      padding: 8px;
      margin-bottom: 10px;
      text-align: center;
      background: var(--md-surface-color);
      box-shadow: 0 2px 4px var(--md-shadow-color);
      height: 100%;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      position: relative;
      overflow: hidden; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –≤—ã—Ö–æ–¥—è—â–∏—Ö –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    }

    .product-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--md-shadow-hover);
    }


    .product-image-container {
      position: relative;
      width: 100%;
      height: 100px;
      margin-bottom: 8px;
    }
    
    .product-image {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--md-background-color);
      cursor: pointer;
    }

    .product-name {
      font-size: 0.85rem;
      line-height: 1.2em;
      height: calc(1.2em * 2);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-top: 8px;
      margin-bottom: 5px;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .product-price {
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      background-color: var(--md-primary-color);
      margin-top: 5px;
      margin-bottom: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 30px;
      transition: background-color 0.2s;
      border: none;
    }

    .product-price:hover {
      background-color: var(--md-primary-dark);
    }

    .unit-badge {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background-color: #dc3545;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 2;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 5px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background-color: var(--md-primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .quantity-btn:hover {
      background-color: var(--md-primary-dark);
    }

    .quantity-btn:disabled {
      background-color: var(--md-text-secondary);
      cursor: not-allowed;
    }

    .quantity-input {
      width: 60px;
      height: 32px;
      border: 1px solid var(--md-border-color);
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .quantity-input:focus {
      outline: none;
      border-color: var(--md-primary-light);
      box-shadow: 0 0 0 0.2rem rgba(46, 41, 130, 0.25);
    }

    .fixed-header {
      position: sticky;
      top: 0;
      background-color: var(--md-surface-color);
      z-index: 1020;
      padding: 15px;
      border-bottom: 1px solid var(--md-border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo-mobile {
      display: none;
      text-align: center;
      margin: 0 auto;
    }

    .logo-desktop {
      display: flex;
      align-items: center;
    }

    .language-switcher {
      margin-left: 15px;
    }

    .lang-btn {
      background: none;
      border: 1px solid var(--md-border-color);
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .lang-btn.active {
      background-color: var(--md-primary-color);
      color: white;
      border-color: var(--md-primary-color);
    }

    .lang-btn:not(.active):hover {
      background-color: var(--md-background-color);
    }

    .back-arrow {
      background-color: var(--md-primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 15px;
      transition: all 0.3s ease;
    }

    .back-arrow:hover {
      background-color: var(--md-primary-dark);
      transform: translateY(-1px);
    }

    .back-arrow.hidden {
      display: none;
    }

    .btn-primary {
        background-color: var(--md-primary-color);
        border-color: var(--md-primary-color);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.65rem 1.5rem;
        font-size: 1.05rem;
    }

    .btn-primary:hover {
        background-color: var(--md-primary-dark);
        border-color: var(--md-primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(46, 41, 130, 0.2);
    }
    
    .btn-secondary {
        background-color: var(--md-accent-color);
        border-color: var(--md-accent-color);
        color: white;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 0.65rem 1.5rem;
        font-size: 1.05rem;
    }
    .btn-secondary:hover {
        background-color: #5A5A5A;
        border-color: #5A5A5A;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(66, 66, 66, 0.2);
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 0.65rem 1.5rem;
        font-size: 1.05rem;
    }
    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
    }

    .cart-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 65px;
      height: 65px;
      border-radius: 12px;
      background-color: var(--md-primary-color);
      border: none;
      color: white;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(46, 41, 130, 0.4);
      z-index: 1000;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    .cart-button:hover {
      background-color: var(--md-primary-dark);
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(46, 41, 130, 0.5);
    }

    .cart-total-badge {
      position: fixed;
      bottom: 85px;
      right: 25px;
      background-color: #ff4444;
      color: white;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .modal-content {
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
      border-bottom: 1px solid var(--md-border-color);
      padding: 1rem 1.5rem;
    }
    .modal-title {
      font-weight: 600;
      color: var(--md-text-color);
    }
    .modal-footer {
      border-top: 1px solid var(--md-border-color);
      padding: 1rem 1.5rem;
    }
    .btn-close {
        font-size: 0.9rem;
    }

    .page-state {
      display: none;
    }

    .page-state.active {
      display: block;
    }

    .order-form-section {
      background-color: var(--md-surface-color);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px var(--md-shadow-color);
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--md-primary-color);
      border-bottom: 2px solid var(--md-primary-light);
      padding-bottom: 8px;
    }
    
    .location-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .location-btn {
      flex: 1;
    }
    
    #locationMap {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      border: 1px solid var(--md-border-color);
      margin-top: 10px;
      display: none;
    }
    
    .map-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    
    .cart-summary {
      background-color: var(--md-surface-color);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px var(--md-shadow-color);
    }
    
    .total-amount {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--md-primary-color);
      text-align: right;
    }

    .delivery-note-red {
      color: #dc3545;
      font-weight: 500;
    }

    .cart-item {
      border-bottom: 1px solid var(--md-border-color);
      padding: 10px 0;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
    }
    .cart-item:last-child {
      border-bottom: none;
    }
    .cart-item-content {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .cart-item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
    }
    .cart-item-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .cart-item-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-item-price {
      font-weight: 600;
      color: var(--md-primary-color);
    }
    .cart-item-quantity {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cart-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .cart-quantity-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background-color: var(--md-primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1rem;
    }

    .cart-quantity-btn:hover {
      background-color: var(--md-primary-dark);
    }

    .cart-quantity-btn:disabled {
      background-color: var(--md-text-secondary);
      cursor: not-allowed;
    }

    .cart-quantity-input {
      width: 70px;
      height: 28px;
      border: 1px solid var(--md-border-color);
      border-radius: 6px;
      text-align: center;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .cart-quantity-input:focus {
      outline: none;
      border-color: var(--md-primary-light);
      box-shadow: 0 0 0 0.2rem rgba(46, 41, 130, 0.25);
    }

    .remove-item-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-left: auto;
    }

    .remove-item-btn:hover {
      background-color: #c82333;
    }

    .payment-methods-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .payment-method {
      border: 2px solid var(--md-border-color);
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .payment-method:hover {
      border-color: var(--md-primary-light);
    }

    .payment-method.selected {
      border-color: var(--md-primary-color);
      background-color: rgba(46, 41, 130, 0.05);
    }

    .payment-method input[type="radio"] {
      margin-right: 10px;
    }

    .required-field::after {
      content: " *";
      color: #dc3545;
    }

    .category-grid {
      display: grid;
      gap: 15px;
      padding: 10px 0;
      grid-template-columns: repeat(5, 1fr);
    }

    .product-grid {
      display: grid;
      gap: 8px;
      padding: 10px 0;
      grid-template-columns: repeat(5, 1fr);
    }

    .success-modal .modal-content {
      text-align: center;
      padding: 20px;
    }
    .success-icon {
      font-size: 4rem;
      color: #28a745;
      margin-bottom: 20px;
    }

    .location-help {
      margin-top: 10px;
    }

    .alert-info {
      border-radius: 8px;
      border: 1px solid #b6d4fe;
    }

    @media (max-width: 1200px) {
      .category-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .product-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 992px) {
      .category-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .product-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 767px) {
      .container {
        padding: 0 5px !important;
      }
      
      .fixed-header {
        padding: 10px;
      }
      
      .category-grid {
        gap: 10px;
        grid-template-columns: repeat(2, 1fr);
      }
      
      .product-grid {
        gap: 5px;
        grid-template-columns: repeat(2, 1fr);
      }
      
      .category-card {
        padding: 10px;
        margin-bottom: 10px;
      }
      
      .category-image {
        height: 80px;
        margin-bottom: 8px;
      }
      
      .category-name {
        font-size: 0.95rem;
      }
      
      .product-card {
        padding: 5px;
        margin-bottom: 5px;
        border-radius: 6px;
      }
      
      .product-image {
        height: 70px;
        border-radius: 4px;
      }
      
      .product-name {
        font-size: 0.75rem;
        line-height: 1.1em;
        height: calc(1.1em * 2);
        margin-top: 5px;
        margin-bottom: 3px;
        -webkit-line-clamp: 2;
      }
      
      .product-price {
        font-size: 0.7rem;
        padding: 6px;
      }
      
      .unit-badge {
        bottom: 55px;
        right: 10px;
        width: 25px;
        height: 25px;
        font-size: 0.6rem;
      }
      
      .quantity-btn {
        width: 24px;
        height: 24px;
        font-size: 14px;
        border-radius: 4px;
      }
      
      .quantity-input {
        width: 50px;
        height: 24px;
        font-size: 0.8rem;
      }
      
      .back-arrow {
        width: 35px;
        height: 35px;
        font-size: 18px;
        margin-right: 10px;
      }

      .logo-desktop {
        display: none;
      }
      
      .logo-mobile {
        display: block;
        flex: 1;
        text-align: center;
      }
      
      .header-content h4 {
        font-size: 1.1rem;
        display: none;
      }

      .order-form-section {
        padding: 15px;
      }

      .location-buttons {
        flex-direction: column;
      }
      
      #locationMap {
        height: 250px;
      }

      .cart-total-badge {
        bottom: 75px;
        right: 20px;
        font-size: 0.8rem;
        padding: 6px 10px;
      }

      .cart-button {
        width: 55px;
        height: 55px;
        font-size: 24px;
        bottom: 20px;
        right: 20px;
      }

      .cart-item-image {
        width: 50px;
        height: 50px;
        margin-right: 10px;
      }
    }

    @media (max-width: 480px) {
      .category-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .product-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container my-3">
    <div class="fixed-header">
      <div class="header-content">
        <div class="header-left">
          <button class="back-arrow hidden" id="backArrow" onclick="showCategoriesPage()">
            <i class="bi bi-arrow-left"></i>
          </button>
          <div class="logo-desktop">
            <img src="https://iili.io/KXB1Kut.png" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 40px;">
          </div>
          <div class="logo-mobile">
            <img src="https://iili.io/KXB1Kut.png" alt="–õ–æ–≥–æ—Ç–∏–ø" style="height: 35px;">
          </div>
        </div>
        <div class="language-switcher">
          <button class="lang-btn active" id="langRu" onclick="switchLanguage('ru')">RU</button>
          <button class="lang-btn" id="langUz" onclick="switchLanguage('uz')">UZ</button>
        </div>
      </div>
    </div>

    <!-- Categories Page -->
    <div id="categoriesPage" class="page-state active">
      <div id="categoriesContent"></div>
    </div>

    <!-- Products Page -->
    <div id="productsPage" class="page-state">
      <div id="productsContent"></div>
    </div>
  </div>

  <!-- Cart Total Badge -->
  <div class="cart-total-badge" id="cartTotalBadge" style="display: none;">
    <span id="totalText">–ò—Ç–æ–≥–æ:</span> <span id="totalAmountBadge">0</span> <span id="currencyText">—Å—É–º</span>
  </div>

  <button class="cart-button" onclick="openCart()">
    <i class="bi bi-cart-fill"></i>
  </button>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- –ë–ª–æ–∫ 1: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞ -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="dateTimeTitle">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞</span></h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="orderDate" class="form-label required-field"><span id="orderDateLabel">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</span></label>
                <input type="date" class="form-control" id="orderDate" required min="" max="">
              </div>
              <div class="col-md-6">
                <label for="orderTime" class="form-label required-field"><span id="orderTimeLabel">–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞</span></label>
                <input type="time" class="form-control" id="orderTime" required>
              </div>
            </div>
          </div>

          <!-- –ë–ª–æ–∫ 2: –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="yourOrderTitle">–í–∞—à –∑–∞–∫–∞–∑</span></h6>
            <div id="cartItems"></div>
            <div class="cart-summary">
              <div class="total-amount" id="totalAmount"><span id="totalTextModal">–ò—Ç–æ–≥–æ:</span> 0 <span id="currencyTextModal">—Å—É–º</span></div>
              <div class="small mt-2 delivery-note-red">* <span id="deliveryNote">üöï –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –∏ –±—É–¥–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ</span></div>
            </div>
          </div>

          <!-- –ë–ª–æ–∫ 3: –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="contactDetailsTitle">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span></h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="customerPhone" class="form-label required-field"><span id="phoneLabel">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span></label>
                <input type="tel" class="form-control" id="customerPhone" placeholder="+998 __ ___ __ __" required>
              </div>
              <div class="col-md-6">
                <label for="customerName" class="form-label required-field"><span id="nameLabel">–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç (–§–ò–û)</span></label>
                <input type="text" class="form-control" id="customerName" placeholder="" required>
              </div>
            </div>
          </div>

          <!-- –ë–ª–æ–∫ 4: –õ–æ–∫–∞—Ü–∏—è -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="locationTitle">–õ–æ–∫–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏</span></h6>
            <div class="location-buttons">
              <button type="button" class="btn btn-outline-secondary location-btn" onclick="showLocationMap()">
                <i class="bi bi-map"></i> <span id="mapButtonText">–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
              </button>
            </div>
            <textarea class="form-control" id="customerLocation" placeholder="" rows="3" required readonly></textarea>
            <div id="locationMap"></div>
            <div class="map-controls" id="mapControls" style="display: none;">
              <button type="button" class="btn btn-success btn-sm" onclick="confirmLocation()">
                <i class="bi bi-check-lg"></i> <span id="confirmAddressText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å</span>
              </button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="hideLocationMap()">
                <i class="bi bi-x-lg"></i> <span id="hideMapText">–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</span>
              </button>
            </div>
          </div>

          <!-- –ë–ª–æ–∫ 5: –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="paymentTitle">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</span></h6>
            <div class="payment-methods-container">
              <div class="payment-method" id="cardPaymentMethod" onclick="selectPaymentMethod('card')">
                <input type="radio" id="cardPayment" name="paymentMethod" value="card" checked>
                <label for="cardPayment" class="form-check-label">üí≥ <span id="cardPaymentText">–ü–æ –∫–∞—Ä—Ç–µ</span></label>
              </div>
              <div class="payment-method" id="cashPaymentMethod" onclick="selectPaymentMethod('cash')">
                <input type="radio" id="cashPayment" name="paymentMethod" value="cash">
                <label for="cashPayment" class="form-check-label">üíµ <span id="cashPaymentText">–ù–∞–ª–∏—á–Ω—ã–º–∏</span></label>
              </div>
            </div>
          </div>

          <!-- –ë–ª–æ–∫ 6: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
          <div class="order-form-section">
            <h6 class="section-title"><span id="commentTitle">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</span></h6>
            <textarea class="form-control" id="orderComment" placeholder="" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="closeText">–ó–∞–∫—Ä—ã—Ç—å</span></button>
          <button type="button" class="btn btn-primary" id="submitOrderBtn" onclick="submitOrder()"><span id="orderButtonText">–ó–∞–∫–∞–∑–∞—Ç—å</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade success-modal" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="success-icon">
            <i class="bi bi-check-circle-fill"></i>
          </div>
          <h4><span id="successTitle">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</span></h4>
          <p id="successOrderNumber" class="fw-bold"></p>
          <p><span id="successMessage">–í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É.</span></p>
          <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">
            <span id="successButtonText">OK</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã API -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=9c06bad6-a1bb-4c9e-a149-de860268d435&lang=ru_RU" type="text/javascript"></script>
  <script>
    let cart = {};
    let allProducts = [];
    let categoryImages = {};
    let categoryNamesRU = {};
    let categoryNamesUZ = {};
    let currentCategory = null;
    let currentLanguage = 'ru';
    let cartModalInstance = null;
    let successModalInstance = null;
    let map = null;
    let placemark = null;
    let selectedLocation = null;

    // –¢–µ–∫—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
    const translations = {
      ru: {
        total: '–ò—Ç–æ–≥–æ:',
        currency: '—Å—É–º',
        categories: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏',
        products: '–¢–æ–≤–∞—Ä—ã',
        order: '–ó–∞–∫–∞–∑',
        dateTime: '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞',
        orderDate: '–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞',
        orderTime: '–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞',
        yourOrder: '–í–∞—à –∑–∞–∫–∞–∑',
        contactDetails: '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
        phone: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
        name: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç (–§–ò–û)',
        location: '–õ–æ–∫–∞—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏',
        mapButton: '–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ',
        confirmAddress: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å',
        hideMap: '–°–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É',
        payment: '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã',
        cardPayment: '–ü–æ –∫–∞—Ä—Ç–µ',
        cashPayment: '–ù–∞–ª–∏—á–Ω—ã–º–∏',
        comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É',
        removeItem: '–£–¥–∞–ª–∏—Ç—å',
        close: '–ó–∞–∫—Ä—ã—Ç—å',
        orderButton: '–ó–∞–∫–∞–∑–∞—Ç—å',
        deliveryNote: 'üöï –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞ –∏ –±—É–¥–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ',
        successTitle: '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!',
        successMessage: '–í–∞—à –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É.',
        successButton: 'OK',
        emptyCart: '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞',
        requiredField: '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ'
      },
      uz: {
        total: 'Jami:',
        currency: 'so ªm',
        categories: 'Kategoriyalar',
        products: 'Mahsulotlar',
        order: 'Buyurtma',
        dateTime: 'Buyurtma sanasi va vaqti',
        orderDate: 'Buyurtma sanasi',
        orderTime: 'Buyurtma vaqti',
        yourOrder: 'Sizning buyurtmangiz',
        contactDetails: 'Aloqa ma\'lumotlari',
        phone: 'Telefon raqami',
        name: 'Ismingiz (F.I.SH)',
        location: 'Yetkazib berish manzili',
        mapButton: 'Xaritadan tanlang',
        confirmAddress: 'Manzilni tasdiqlang',
        hideMap: 'Xaritani yashirish',
        payment: 'To\'lov usuli',
        cardPayment: 'Kartaga orqali',
        cashPayment: 'Naqd pul',
        comment: 'Buyurtma uchun izoh',
        removeItem: 'O\'chirish',
        close: 'Yopish',
        orderButton: 'Buyurtma berish',
        deliveryNote: 'üöï Yetkazib berish narxi kiritilmagan va alohida hisoblanadi',
        successTitle: 'Buyurtma qabul qilindi!',
        successMessage: 'Sizning buyurtmangiz muvaffaqiyatli rasmiylashtirildi va qayta ishlash uchun topshirildi.',
        successButton: 'OK',
        emptyCart: 'Savat bo\'sh',
        requiredField: 'Majburiy maydon'
      }
    };

    $(document).ready(function() {
      console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      
      cartModalInstance = new bootstrap.Modal(document.getElementById('cartModal'), {
        backdrop: 'static',
        keyboard: false
      });

      successModalInstance = new bootstrap.Modal(document.getElementById('successModal'));

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setDefaultDateTime();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      google.script.run.withSuccessHandler(initializeAppData).getAppData();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
      ymaps.ready(initMap);
    });

    function switchLanguage(lang) {
      currentLanguage = lang;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞
      document.getElementById('langRu').classList.toggle('active', lang === 'ru');
      document.getElementById('langUz').classList.toggle('active', lang === 'uz');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã
      updateAllTexts();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ç–æ–≤–∞—Ä–æ–≤
      if (currentCategory) {
        updateProductsDisplay();
      } else {
        updateCategoriesDisplay();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
      if (document.getElementById('cartModal').classList.contains('show')) {
        updateCartDisplay();
      }
    }

    function updateAllTexts() {
      const t = translations[currentLanguage];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
      document.getElementById('totalText').textContent = t.total;
      document.getElementById('currencyText').textContent = t.currency;
      document.getElementById('totalTextModal').textContent = t.total;
      document.getElementById('currencyTextModal').textContent = t.currency;
      document.getElementById('cartModalLabel').textContent = t.order;
      document.getElementById('dateTimeTitle').textContent = t.dateTime;
      document.getElementById('orderDateLabel').textContent = t.orderDate;
      document.getElementById('orderTimeLabel').textContent = t.orderTime;
      document.getElementById('yourOrderTitle').textContent = t.yourOrder;
      document.getElementById('contactDetailsTitle').textContent = t.contactDetails;
      document.getElementById('phoneLabel').textContent = t.phone;
      document.getElementById('nameLabel').textContent = t.name;
      document.getElementById('locationTitle').textContent = t.location;
      document.getElementById('mapButtonText').textContent = t.mapButton;
      document.getElementById('confirmAddressText').textContent = t.confirmAddress;
      document.getElementById('hideMapText').textContent = t.hideMap;
      document.getElementById('paymentTitle').textContent = t.payment;
      document.getElementById('cardPaymentText').textContent = t.cardPayment;
      document.getElementById('cashPaymentText').textContent = t.cashPayment;
      document.getElementById('commentTitle').textContent = t.comment;
      document.getElementById('closeText').textContent = t.close;
      document.getElementById('orderButtonText').textContent = t.orderButton;
      document.getElementById('deliveryNote').textContent = t.deliveryNote;
      document.getElementById('successTitle').textContent = t.successTitle;
      document.getElementById('successMessage').textContent = t.successMessage;
      document.getElementById('successButtonText').textContent = t.successButton;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
      document.getElementById('customerPhone').placeholder = currentLanguage === 'ru' ? '+998 __ ___ __ __' : '+998 __ ___ __ __';
      document.getElementById('customerName').placeholder = currentLanguage === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û' : 'Ismingizni kiriting (F.I.SH)';
      document.getElementById('customerLocation').placeholder = currentLanguage === 'ru' ? '–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞ –∫–∞—Ä—Ç–µ' : 'Xaritadan manzilni tanlang';
      document.getElementById('orderComment').placeholder = currentLanguage === 'ru' ? '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ç.–¥.' : 'Qo\'shimcha istaklar, yetkazib berish xususiyatlari va h.k.';
    }

    function setDefaultDateTime() {
      const now = new Date();
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)
      const maxDate = new Date(now);
      maxDate.setDate(now.getDate() + 7);
      const maxDateString = maxDate.toISOString().split('T')[0];
      document.getElementById('orderDate').max = maxDateString;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
      const today = now.toISOString().split('T')[0];
      document.getElementById('orderDate').min = today;
      document.getElementById('orderDate').value = today;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 1 —á–∞—Å)
      const futureTime = new Date(now.getTime() + 60 * 60 * 1000);
      const timeString = futureTime.toTimeString().substring(0, 5);
      document.getElementById('orderTime').value = timeString;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
      updateMinTime();
    }

    function updateMinTime() {
      const orderDate = document.getElementById('orderDate').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (orderDate === today) {
        const now = new Date();
        const futureTime = new Date(now.getTime() + 60 * 60 * 1000); // +1 —á–∞—Å
        const minTime = futureTime.toTimeString().substring(0, 5);
        document.getElementById('orderTime').min = minTime;
        
        const selectedTime = document.getElementById('orderTime').value;
        if (selectedTime < minTime) {
          document.getElementById('orderTime').value = minTime;
        }
      } else {
        document.getElementById('orderTime').min = '00:00';
      }
    }

    function selectPaymentMethod(method) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
      document.getElementById('cashPayment').checked = method === 'cash';
      document.getElementById('cardPayment').checked = method === 'card';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
      document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
      });
      
      if (method === 'cash') {
        document.getElementById('cashPaymentMethod').classList.add('selected');
      } else {
        document.getElementById('cardPaymentMethod').classList.add('selected');
      }
    }

    function initializeAppData(data) {
      if (data.message) {
        document.getElementById('categoriesContent').innerHTML = '<h3>' + data.message + '</h3>';
        return;
      }
      allProducts = data.products;
      categoryImages = data.categoryImages;
      categoryNamesRU = data.categoryNamesRU || {};
      categoryNamesUZ = data.categoryNamesUZ || {};
      
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–æ–π
      selectPaymentMethod('card');
      
      showCategoriesPage();
    }

    function showCategoriesPage() {
      currentCategory = null;
      document.getElementById('categoriesPage').classList.add('active');
      document.getElementById('productsPage').classList.remove('active');
      document.getElementById('backArrow').classList.add('hidden');
      
      window.scrollTo(0, 0);
      updateCategoriesDisplay();
    }

    function showProductsPage(categoryName) {
      currentCategory = categoryName;
      document.getElementById('categoriesPage').classList.remove('active');
      document.getElementById('productsPage').classList.add('active');
      document.getElementById('backArrow').classList.remove('hidden');
      
      updateProductsDisplay();
    }

    function updateCategoriesDisplay() {
      const content = document.getElementById('categoriesContent');
      content.innerHTML = '';
      
      const allAvailableCategories = [];
      const seenCategories = new Set();
      allProducts.forEach(function(product) {
        if (product.category && !seenCategories.has(product.category)) {
          allAvailableCategories.push(product.category);
          seenCategories.add(product.category);
        }
      });
      allAvailableCategories.sort();
      
      if (allAvailableCategories.length === 0) {
        content.innerHTML = '<p>' + (currentLanguage === 'ru' ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤.' : 'Mavjud mahsulot kategoriyalari yo\'q.') + '</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'category-grid';
      content.appendChild(grid);

      allAvailableCategories.forEach(function(category) {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.dataset.categoryName = category;

        const categoryImage = categoryImages[category] || 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png';
        
        const img = document.createElement('img');
        img.src = categoryImage;
        img.className = 'category-image';
        img.alt = category;
        img.onerror = function() {
          this.src = 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png';
        };
        
        const nameEl = document.createElement('h5');
        nameEl.className = 'category-name';
        nameEl.textContent = currentLanguage === 'ru' ? 
          (categoryNamesRU[category] || category) : 
          (categoryNamesUZ[category] || category);
        
        card.appendChild(img);
        card.appendChild(nameEl);
        
        card.addEventListener('click', function() {
          showProductsPage(category);
        });
        
        grid.appendChild(card);
      });
    }

    function updateProductsDisplay() {
      const content = document.getElementById('productsContent');
      content.innerHTML = '';
      
      if (!currentCategory) {
        content.innerHTML = '<p>' + (currentLanguage === 'ru' ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.' : 'Kategoriya tanlanmagan.') + '</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'product-grid';
      content.appendChild(grid);

      let categoryProducts = allProducts.filter(function(p) {
        return p.category === currentCategory;
      });
      categoryProducts.sort(function(a, b) {
        const nameA = currentLanguage === 'ru' ? a.nameRU : a.nameUZ;
        const nameB = currentLanguage === 'ru' ? b.nameRU : b.nameUZ;
        return nameA.localeCompare(nameB);
      });
      
      if (categoryProducts.length === 0) {
        content.innerHTML = '<p>' + (currentLanguage === 'ru' ? '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "' : 'Kategoriyada mahsulot yo\'q "') + currentCategory + '".</p>';
        return;
      }

      categoryProducts.forEach(function(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.productName = product.nameRU;

        const img = document.createElement('img');
        img.src = product.image || 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png';
        img.className = 'product-image';
        img.alt = currentLanguage === 'ru' ? product.nameRU : product.nameUZ;
        img.onerror = function() {
          this.src = 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png';
        };
        
        // –ë–µ–π–¥–∂ —Å –µ–¥–∏–Ω–∏—Ü–µ–π –∏–∑–º–µ—Ä–µ–Ω–∏—è
        if (product.unit) {
          const unitBadge = document.createElement('div');
          unitBadge.className = 'unit-badge';
          unitBadge.textContent = product.unit;
          card.appendChild(unitBadge);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        img.addEventListener('click', function() {
          const priceElement = card.querySelector('.product-price');
          if (priceElement && priceElement.style.display !== 'none') {
            showQuantityControls(priceElement, product);
          } else {
            const existingControls = card.querySelector('.quantity-controls');
            if (existingControls) {
              const quantityElement = existingControls.querySelector('.quantity-input');
              const currentQty = parseFloat(quantityElement.value.replace(',', '.'));
              quantityElement.value = (currentQty + 1).toString().replace('.', ',');
              updateQuantity(product.nameRU, currentQty + 1, product.unit);
            }
          }
        });
        
        const nameEl = document.createElement('h5');
        nameEl.className = 'product-name';
        nameEl.textContent = currentLanguage === 'ru' ? product.nameRU : (product.nameUZ || product.nameRU);
        
        const priceEl = document.createElement('button');
        priceEl.className = 'product-price';
        priceEl.textContent = product.price ? formatPrice(product.price) + ' ' + translations[currentLanguage].currency : (currentLanguage === 'ru' ? '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' : 'Narx ko\'rsatilmagan');
        
        card.appendChild(img);
        card.appendChild(nameEl);
        card.appendChild(priceEl);
        
        priceEl.addEventListener('click', function() {
          showQuantityControls(priceEl, product);
        });
        
        grid.appendChild(card);
      });
    }

    function showQuantityControls(priceElement, product) {
      const card = priceElement.parentElement;
      const existingControls = card.querySelector('.quantity-controls');
      
      if (existingControls) {
        return;
      }

      const controls = document.createElement('div');
      controls.className = 'quantity-controls';

      const minusBtn = document.createElement('button');
      minusBtn.className = 'quantity-btn';
      minusBtn.innerHTML = '<i class="bi bi-dash"></i>';

      const quantityInput = document.createElement('input');
      quantityInput.type = 'text';
      quantityInput.className = 'quantity-input';
      quantityInput.value = '1';
      quantityInput.inputMode = 'decimal';

      const plusBtn = document.createElement('button');
      plusBtn.className = 'quantity-btn';
      plusBtn.innerHTML = '<i class="bi bi-plus"></i>';

      controls.appendChild(minusBtn);
      controls.appendChild(quantityInput);
      controls.appendChild(plusBtn);

      priceElement.style.display = 'none';
      card.appendChild(controls);

      addToCart(product.nameRU, 1, product.unit, product.price);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      quantityInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(',', '.');
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –∏ —Ç–æ—á–∫—É/–∑–∞–ø—è—Ç—É—é
        value = value.replace(/[^\d.,]/g, '');
        
        // –ó–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é
        e.target.value = value.replace('.', ',');
        
        const quantity = parseFloat(value) || 0;
        if (quantity > 0) {
          updateQuantity(product.nameRU, quantity, product.unit);
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
      quantityInput.addEventListener('blur', function() {
        let value = parseFloat(this.value.replace(',', '.')) || 0;
        if (value <= 0) {
          value = 1;
          this.value = '1';
          updateQuantity(product.nameRU, 1, product.unit);
        }
      });

      plusBtn.addEventListener('click', function() {
        let currentQty = parseFloat(quantityInput.value.replace(',', '.')) || 0;
        currentQty++;
        quantityInput.value = currentQty.toString().replace('.', ',');
        updateQuantity(product.nameRU, currentQty, product.unit);
      });

      minusBtn.addEventListener('click', function() {
        let currentQty = parseFloat(quantityInput.value.replace(',', '.')) || 0;
        currentQty--;
        
        if (currentQty <= 0) {
          card.removeChild(controls);
          priceElement.style.display = 'block';
          removeFromCart(product.nameRU);
        } else {
          quantityInput.value = currentQty.toString().replace('.', ',');
          updateQuantity(product.nameRU, currentQty, product.unit);
        }
      });

      quantityInput.focus();
    }

    function formatPrice(price) {
      return new Intl.NumberFormat('ru-RU').format(price);
    }

    function addToCart(name, qty, unit, price) {
      cart[name] = {
        quantity: qty,
        unit: unit,
        price: price
      };
      updateCartBadge();
    }

    function updateQuantity(name, newQty, unit) {
      if (cart[name]) {
        cart[name].quantity = newQty;
        updateCartBadge();
      }
    }

    function removeFromCart(name) {
      delete cart[name];
      updateCartBadge();
    }

    function calculateTotal() {
      let total = 0;
      Object.keys(cart).forEach(function(name) {
        const item = cart[name];
        if (item && item.price) {
          total += item.quantity * item.price;
        }
      });
      return total;
    }

    function updateCartBadge() {
      const total = calculateTotal();
      const badge = document.getElementById('cartTotalBadge');
      const badgeAmount = document.getElementById('totalAmountBadge');
      
      badgeAmount.textContent = formatPrice(total);
      
      if (Object.keys(cart).length > 0) {
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    function openCart() {
      updateCartDisplay();
      cartModalInstance.show();
    }

    function updateCartDisplay() {
      const cartItems = document.getElementById('cartItems');
      const t = translations[currentLanguage];
      
      cartItems.innerHTML = '';
      
      if (Object.keys(cart).length === 0) {
        cartItems.innerHTML = '<p>' + t.emptyCart + '</p>';
      } else {
        const itemsInCart = Object.keys(cart).map(function(name) {
          const item = cart[name];
          const product = allProducts.find(function(p) {
            return p.nameRU === name;
          });
          return { 
            name: name, 
            quantity: item.quantity, 
            unit: item.unit,
            price: item.price,
            image: product ? product.image : 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png',
            nameUZ: product ? product.nameUZ : name
          };
        });
        itemsInCart.sort(function(a, b) {
          const nameA = currentLanguage === 'ru' ? a.name : a.nameUZ;
          const nameB = currentLanguage === 'ru' ? b.name : b.nameUZ;
          return nameA.localeCompare(nameB);
        });
        
        itemsInCart.forEach(function(item, index) {
          const itemElement = document.createElement('div');
          itemElement.className = 'cart-item';
          
          const img = document.createElement('img');
          img.src = item.image;
          img.className = 'cart-item-image';
          img.alt = currentLanguage === 'ru' ? item.name : item.nameUZ;
          img.onerror = function() {
            this.src = 'https://www.landuse-ca.org/wp-content/uploads/2019/04/no-photo-available.png';
          };
          
          const itemContent = document.createElement('div');
          itemContent.className = 'cart-item-content';
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'cart-item-name';
          nameDiv.textContent = (index + 1) + '. ' + (currentLanguage === 'ru' ? item.name : (item.nameUZ || item.name));
          
          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'cart-item-details';
          
          const priceSpan = document.createElement('span');
          priceSpan.className = 'cart-item-price';
          priceSpan.textContent = formatPrice(item.price * item.quantity) + ' ' + t.currency;
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-item-btn';
          removeBtn.textContent = t.removeItem;
          removeBtn.onclick = function() {
            removeFromCart(item.name);
          };
          
          detailsDiv.appendChild(priceSpan);
          detailsDiv.appendChild(removeBtn);
          
          // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'cart-controls';
          
          const minusBtn = document.createElement('button');
          minusBtn.className = 'cart-quantity-btn';
          minusBtn.textContent = '-';
          minusBtn.onclick = function() {
            updateCartItemQuantity(item.name, item.quantity - 1);
          };
          
          const quantityInput = document.createElement('input');
          quantityInput.type = 'text';
          quantityInput.className = 'cart-quantity-input';
          quantityInput.value = item.quantity + ' ' + item.unit;
          quantityInput.readOnly = false;
          quantityInput.onchange = function() {
            const newQty = parseFloat(this.value);
            if (!isNaN(newQty) && newQty > 0) {
              updateCartItemQuantity(item.name, newQty);
            } else {
              this.value = item.quantity + ' ' + item.unit;
            }
          };
          
          const plusBtn = document.createElement('button');
          plusBtn.className = 'cart-quantity-btn';
          plusBtn.textContent = '+';
          plusBtn.onclick = function() {
            updateCartItemQuantity(item.name, item.quantity + 1);
          };
          
          controlsDiv.appendChild(minusBtn);
          controlsDiv.appendChild(quantityInput);
          controlsDiv.appendChild(plusBtn);
          
          itemContent.appendChild(nameDiv);
          itemContent.appendChild(detailsDiv);
          itemContent.appendChild(controlsDiv);
          
          itemElement.appendChild(img);
          itemElement.appendChild(itemContent);
          
          cartItems.appendChild(itemElement);
        });
      }
      
      updateTotal();
    }

    function updateTotal() {
      const total = calculateTotal();
      document.getElementById('totalAmount').innerHTML = '<span id="totalTextModal">' + translations[currentLanguage].total + '</span> ' + formatPrice(total) + ' <span id="currencyTextModal">' + translations[currentLanguage].currency + '</span>';
    }

    function removeFromCart(productName) {
      if (cart[productName]) {
        delete cart[productName];
        updateCartDisplay();
        updateCartBadge();
      }
    }

    function updateCartItemQuantity(productName, newQuantity) {
      if (cart[productName]) {
        if (newQuantity <= 0) {
          removeFromCart(productName);
        } else {
          cart[productName].quantity = newQuantity;
          updateCartDisplay();
          updateCartBadge();
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ–π (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function initMap() {
        if (typeof ymaps === 'undefined') {
            console.error('Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            return;
        }
        map = new ymaps.Map('locationMap', {
            center: [41.311081, 69.240562],
            zoom: 10
        }, {
            searchControlProvider: 'yandex#search'
        });
        const geolocationControl = new ymaps.control.GeolocationControl({
            options: {
                noPlacemark: true,
                position: {
                    right: 10,
                    top: 10
                }
            }
        });
        map.controls.add(geolocationControl);
        geolocationControl.events.add('locationchange', function (e) {
            const position = e.get('position');
            setUserLocation(position);
        });
        geolocationControl.events.add('locationerror', function (e) {
            console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:', e.get('error'));
            determineLocationByIP();
        });
        map.events.add('click', function(e) {
            const coords = e.get('coords');
            setUserLocation(coords);
        });
    }

    function determineLocationByIP() {
        fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    const coords = [data.latitude, data.longitude];
                    setUserLocation(coords);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ IP:', error);
            });
    }

    function setUserLocation(coords) {
        if (!map) return;
        if (placemark) {
            map.geoObjects.remove(placemark);
        }
        placemark = new ymaps.Placemark(coords, {
            balloonContent: currentLanguage === 'ru' ? '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' : 'Sizning joylashuvingiz'
        }, {
            preset: 'islands#blueCircleDotIcon',
            draggable: true
        });
        map.geoObjects.add(placemark);
        map.setCenter(coords, 15);
        ymaps.geocode(coords).then(function(res) {
            const firstGeoObject = res.geoObjects.get(0);
            let address = firstGeoObject.getAddressLine();
            if (address.length > 100) {
                address = firstGeoObject.getThoroughfare() || firstGeoObject.getPremise() || address;
            }
            document.getElementById('customerLocation').value = address;
            selectedLocation = {
                address: address,
                coordinates: coords,
                latitude: coords[0].toFixed(6),
                longitude: coords[1].toFixed(6)
            };
        }).catch(function(error) {
            const address = (currentLanguage === 'ru' ? '–®–∏—Ä–æ—Ç–∞: ' : 'Kenglik: ') + coords[0].toFixed(6) + ', ' + (currentLanguage === 'ru' ? '–î–æ–ª–≥–æ—Ç–∞: ' : 'Uzunlik: ') + coords[1].toFixed(6);
            document.getElementById('customerLocation').value = address;
            selectedLocation = {
                address: address,
                coordinates: coords,
                latitude: coords[0].toFixed(6),
                longitude: coords[1].toFixed(6)
            };
        });
        placemark.events.add('dragend', function (e) {
            const newCoords = placemark.geometry.getCoordinates();
            ymaps.geocode(newCoords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                const address = firstGeoObject.getAddressLine();
                document.getElementById('customerLocation').value = address;
                selectedLocation = {
                    address: address,
                    coordinates: newCoords,
                    latitude: newCoords[0].toFixed(6),
                    longitude: newCoords[1].toFixed(6)
                };
            });
        });
    }

    function showLocationMap() {
        const mapElement = document.getElementById('locationMap');
        const mapControls = document.getElementById('mapControls');
        mapElement.style.display = 'block';
        mapControls.style.display = 'flex';
        if (!map) {
            createMap();
        } else {
            setTimeout(() => {
                determineUserLocation();
            }, 500);
        }
    }

    function determineUserLocation() {
        if (!map) return;
        if (navigator.geolocation) {
            const locationBtn = document.querySelector('.location-btn');
            const originalText = locationBtn.innerHTML;
            locationBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ' + (currentLanguage === 'ru' ? '–ü–æ–∏—Å–∫...' : 'Qidirilmoqda...');
            locationBtn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    setUserLocation(coords);
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                },
                function(error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
                    determineLocationByIP();
                    locationBtn.innerHTML = originalText;
                    locationBtn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            determineLocationByIP();
        }
    }

    function hideLocationMap() {
        const mapElement = document.getElementById('locationMap');
        const mapControls = document.getElementById('mapControls');
        mapElement.style.display = 'none';
        mapControls.style.display = 'none';
        const helpElement = document.querySelector('.location-help');
        if (helpElement) {
            helpElement.remove();
        }
    }

    function confirmLocation() {
        if (selectedLocation && selectedLocation.address) {
            document.getElementById('customerLocation').value = selectedLocation.address;
            hideLocationMap();
        } else {
            alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ, –∫–ª–∏–∫–Ω—É–≤ –ø–æ –Ω–µ–π, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –Ω–∞ –∫–∞—Ä—Ç–µ.' : 'Iltimos, xaritada nuqtani tanlang yoki xaritadan qidiruvdan foydalaning.');
        }
    }

    function submitOrder() {
      const orderDate = document.getElementById('orderDate').value;
      const orderTime = document.getElementById('orderTime').value;
      const phone = document.getElementById('customerPhone').value;
      const customerName = document.getElementById('customerName').value;
      const location = document.getElementById('customerLocation').value;
      const comment = document.getElementById('orderComment').value;
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
      if (!orderDate) {
        alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–∫–∞–∑–∞' : 'Iltimos, buyurtma sanasini tanlang');
        return;
      }
      if (!orderTime) {
        alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–∫–∞–∑–∞' : 'Iltimos, buyurtma vaqtini tanlang');
        return;
      }
      if (!phone) {
        alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' : 'Iltimos, telefon raqamingizni kiriting');
        return;
      }
      if (!customerName) {
        alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û' : 'Iltimos, ismingizni kiriting (F.I.SH)');
        return;
      }
      if (!location) {
        alert(currentLanguage === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –¥–æ—Å—Ç–∞–≤–∫–∏' : 'Iltimos, yetkazib berish manzilini ko\'rsating');
        return;
      }
      if (Object.keys(cart).length === 0) {
        alert(currentLanguage === 'ru' ? '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞' : 'Savat bo\'sh');
        return;
      }

      const submitBtn = document.getElementById('submitOrderBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ' + (currentLanguage === 'ru' ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : 'Yuborilmoqda...');

      const orderDateTime = `${orderDate} ${orderTime}`;
      const formattedDate = new Date(orderDateTime).toLocaleDateString('ru-RU');
      const formattedTime = new Date(orderDateTime).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});

      const order = {
        date: orderDate,
        time: orderTime,
        formattedDate: formattedDate,
        formattedTime: formattedTime,
        department: '–î–æ—Å—Ç–∞–≤–∫–∞',
        phone: phone,
        customerName: customerName,
        location: location,
        coordinates: selectedLocation ? `${selectedLocation.latitude}, ${selectedLocation.longitude}` : '',
        comment: comment,
        paymentMethod: paymentMethod,
        items: Object.keys(cart).map(function(name) {
          const item = cart[name];
          const product = allProducts.find(function(p) {
            return p.nameRU === name;
          });
          return { 
            name: name, 
            quantity: item.quantity, 
            unit: item.unit,
            price: item.price,
            supplier: product ? product.supplier : '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' 
          };
        }),
        total: calculateTotal()
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('successOrderNumber').textContent = (currentLanguage === 'ru' ? '–í–∞—à –∑–∞–∫–∞–∑ ‚Ññ' : 'Sizning buyurtmangiz ‚Ññ') + result.orderNumber;
            cart = {};
            updateCartBadge();
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerLocation').value = '';
            document.getElementById('orderComment').value = '';
            selectedLocation = null;
            setDefaultDateTime();
            if (currentCategory) {
              updateProductsDisplay();
            } else {
              updateCategoriesDisplay();
            }
            cartModalInstance.hide();
            successModalInstance.show();
          } else {
            alert(result.message);
          }
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span id="orderButtonText">' + translations[currentLanguage].orderButton + '</span>';
        })
        .withFailureHandler(function(error) {
          alert((currentLanguage === 'ru' ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' : 'Xatolik yuz berdi: ') + error.message);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span id="orderButtonText">' + translations[currentLanguage].orderButton + '</span>';
        })
        .submitOrder(order);
    }

    function closeSuccessModal() {
      successModalInstance.hide();
      const backdrops = document.querySelectorAll('.modal-backdrop');
      backdrops.forEach(backdrop => {
        backdrop.remove();
      });
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      showCategoriesPage();
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã
    document.getElementById('orderDate').addEventListener('change', updateMinTime);
    document.getElementById('orderTime').addEventListener('change', function() {
      updateMinTime();
    });

    document.addEventListener('DOMContentLoaded', function() {
      const existingBackdrops = document.querySelectorAll('.modal-backdrop');
      existingBackdrops.forEach(function(backdrop) {
        backdrop.remove();
      });
    });
  </script>
</body>
</html>